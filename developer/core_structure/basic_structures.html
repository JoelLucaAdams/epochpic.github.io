<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.8.0"><meta name=description content="This page details a few basic background components of EPOCH. Here we introduce the global shared data modules and its physical constants, variables used to define the cell grid, and the functions used to load macro-particles onto the grid."><link rel=alternate hreflang=en-us href=/developer/core_structure/basic_structures.html><meta name=theme-color content="#3f51b5"><script src=/js/mathjax-config.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js integrity crossorigin=anonymous async></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"><link rel=stylesheet href=/css/academic.css><link rel=manifest href=/index.webmanifest><link rel=icon type=image/png href=/images/icon_hucf2a1ead28adac6bbe3177e5d4e4a1f0_753_32x32_fill_lanczos_center_2.png><link rel=apple-touch-icon type=image/png href=/images/icon_hucf2a1ead28adac6bbe3177e5d4e4a1f0_753_192x192_fill_lanczos_center_2.png><link rel=canonical href=/developer/core_structure/basic_structures.html><meta property="twitter:card" content="summary"><meta property="og:site_name" content="EPOCH"><meta property="og:url" content="/developer/core_structure/basic_structures.html"><meta property="og:title" content="Basic Structures | EPOCH"><meta property="og:description" content="This page details a few basic background components of EPOCH. Here we introduce the global shared data modules and its physical constants, variables used to define the cell grid, and the functions used to load macro-particles onto the grid."><meta property="og:image" content="/images/logo_hub4b4d6a0f57638acebb5550a80c8c030_9243_300x300_fit_lanczos_2.png"><meta property="twitter:image" content="/images/logo_hub4b4d6a0f57638acebb5550a80c8c030_9243_300x300_fit_lanczos_2.png"><meta property="og:locale" content="en-us"><meta property="article:modified_time" content="2023-04-04T13:41:14+01:00"><title>Basic Structures | EPOCH</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/><img src=/images/logo_hub4b4d6a0f57638acebb5550a80c8c030_9243_0x70_resize_lanczos_2.png alt=EPOCH></a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/><img src=/images/logo_hub4b4d6a0f57638acebb5550a80c8c030_9243_0x70_resize_lanczos_2.png alt=EPOCH></a></div><div class="navbar-collapse main-menu-item collapse justify-content-end" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/quickstart.html><span>Quick Start</span></a></li><li class=nav-item><a class=nav-link href=/documentation.html><span>User Guide</span></a></li><li class=nav-item><a class=nav-link href=/developer.html><span>Dev Guide</span></a></li><li class=nav-item><a class=nav-link href=/publication.html><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/license.html><span>License</span></a></li><li class=nav-item><a class=nav-link href=/contact.html><span>Contact</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=#><i class="fas fa-search" aria-hidden=true></i></a></li></ul></div></nav><div class="container-fluid docs"><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 docs-sidebar"><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-3" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation">
<span><i class="fas fa-bars"></i></span></button>
<input name=q type=search class=form-control placeholder=Search... autocomplete=off></form><nav class="collapse docs-links" id=docs-nav><div class=docs-toc-item><a class=docs-toc-link href=/developer.html>Overview</a><ul class="nav docs-sidenav"><li><a href=/developer/source_code_files.html>Source code files</a></li><li><a href=/developer/makefile.html>Makefile</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=/developer/core_structure.html>Core Structure</a><ul class="nav docs-sidenav"><li class=active><a href=/developer/core_structure/basic_structures.html>Basic Structures</a></li><li><a href=/developer/core_structure/macro_particles.html>Particles</a></li><li><a href=/developer/core_structure/linked_lists.html>Linked Lists</a></li><li><a href=/developer/core_structure/partlist.html>Partlist</a></li><li><a href=/developer/core_structure/field_solver.html>Field Solver</a></li><li><a href=/developer/core_structure/particle_pusher.html>Particle Pusher</a></li><li><a href=/developer/core_structure/shape_functions.html>Weighting Functions</a></li><li><a href=/developer/core_structure/current_solver.html>Current solver</a></li><li><a href=/developer/core_structure/boundary_conditions.html>Boundary Conditions</a></li><li><a href=/developer/core_structure/parallelism.html>Parallelism</a></li><li><a href=/developer/core_structure/precompiler_flags.html>Pre-compilation Flags</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=/developer/input_output.html>Input Output</a><ul class="nav docs-sidenav"><li><a href=/developer/input_output/basic_output.html>Basic Output</a></li><li><a href=/developer/input_output/string_handling.html>String Handling</a></li><li><a href=/developer/input_output/error_codes.html>Error Codes</a></li><li><a href=/developer/input_output/adding_outputs.html>Adding Outputs</a></li><li><a href=/developer/input_output/custom_maths_parser.html>Custom Maths Parser</a></li><li><a href=/developer/input_output/custom_deck.html>Custom Deck</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=/developer/extensions.html>Extending EPOCH</a><ul class="nav docs-sidenav"><li><a href=/developer/extensions/input_deck.html>Input Deck</a></li><li><a href=/developer/extensions/maths_parser.html>Maths Parser</a></li><li><a href=/developer/extensions/new_modules.html>New Module</a></li></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>Contents</a></li></ul><nav id=TableOfContents><ul><li><a href=#physical-constants>Physical constants</a></li><li><a href=#shape-and-size-variables>Shape and size variables</a></li><li><a href=#the-timestep>The timestep</a></li><li><a href=#input-deck-variables>Input deck variables</a></li><li><a href=#initial-conditions-autoloader-variables>Initial conditions (autoloader) variables</a></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role=main><article class=article><div class=docs-article-container><h1>Basic Structures</h1><div class=article-style><p>This page details a few basic background components of EPOCH. Here we introduce
the global shared data modules and its physical constants, variables used to
define the cell grid, and the functions used to load macro-particles onto the
grid.</p><h2 id=physical-constants>Physical constants</h2><p>In order to ensure that different parts of the code run at the same precision
common physical constants are defined in <code>constants.F90</code> and any
new physical constants required by extensions to the code should be placed in
the same location. The constants available in the code are</p><ul><li>pi - Ratio of a circle&rsquo;s circumference to its diameter.</li><li>q0 - Charge on electron.</li><li>m0 - Rest mass of electron.</li><li>c - Speed of light in vacuum.</li><li>kb - Boltzmann&rsquo;s constant.</li><li>mu0 - Permeability of free space.</li><li>epsilon0 - Permittivity of free space.</li><li>h_planck - Planck&rsquo;s constant.</li><li>ev - The value of an electron volt.</li><li>h_bar - Planck&rsquo;s constant divided by $2\pi$ .</li><li>a0 - The Bohr radius.</li><li>hartree - Double the Rydberg energy.</li><li>alpha - Fine structure constant.</li><li>atomic_time - Time in atomic units (h_bar / hartree).</li><li>atomic_electric_field - Electric field in atomic units (hatree / q0 / a0).</li><li>mc0 - Electron mass * speed of light.</li><li>m0c2 - Electron rest mass energy.</li></ul><p>Further constants are used in the QED (photons) physics package and the
bremsstrahlnug package.</p><p>Any new constants required should be specified in the same place in
<code>constants.F90</code>.</p><h2 id=shape-and-size-variables>Shape and size variables</h2><p>As well as the physical constants, there are some important variables which
you will have to use to do any development with EPOCH. As a general note,
since EPOCH is written with separate 1D, 2D and 3D versions, definitions will
be given for the 3D version of the code and irrelevant dimensions should just
be left out.</p><ul><li><p><code>INTEGER :: nx, ny, nz</code> - The number of gridpoints on the current
processor in each direction. This may change when the load balancer
activates, so always use these variables rather than local copies.</p></li><li><p><code>INTEGER :: nx_global, ny_global, nz_global</code> - The number of gridpoints
in each direction of the whole domain. These numbers will never change and
will be the numbers read in from the input deck.</p></li><li><p><code>INTEGER(KIND=8) :: npart_global</code> - The global number of particles
specified in the input deck. This is not updated as particles leave the
domain through boundaries etc. so it is not guaranteed to be accurate.</p></li><li><p><code>INTEGER :: n_species</code> - The number of species of particles specified.</p></li><li><p><code>INTEGER :: nsteps</code> - The maximum number of steps that the core solver
should take.</p></li><li><p><code>INTEGER, DIMENSION(1:nproc{x,y,z}), ALLOCATABLE :: cell_{x,y,z}_min,</code>
<code>cell_{x,y,z}_max</code> - The variables <code>cell_{x,y,z}_min</code> and
<code>cell_{x,y,z}_max</code> represent the part of a global array which is held by the
current processor. Since EPOCH is an MPI code, there doesn&rsquo;t exist a
single copy of any of the global arrays anywhere, but if there did then each
processor would be responsible for the slice which runs
(cell_x_min(rank):cell_x_max(rank),
cell_y_min(rank):cell_y_max(rank))
in 2D. These variables are used internally in the load balancer, where it is
updated, but is also used when calculating distribution functions. Here it is
used to define the extents of the MPI type which is used to write the
distribution function to disk.</p></li></ul><p>-Useful global parameters exist for tracking the position and size of the fields
stored by each MPI rank. The variables:</p><ul><li><p><code>INTERGER :: {x,y,z}_grid_min_local</code> - These give the position of the
cell-<strong>centre</strong> which has indices (1,1,1) on the current MPI rank. The grids on
each rank only contain a fraction of the total simulation cells.</p></li><li><p><code>LOGICAL :: {x,y,z}_{min,max}_boundary</code> - Logical flags to determine whether
the current rank is on the simulation edge. If <code>x_min_boundary</code> is true, then
the current MPI rank has no neighbouring ranks on the low-$x$ edge.</p></li></ul><h2 id=the-timestep>The timestep</h2><p>The timestep is calculated in the subroutine <code>set_dt</code> in the file
<code>src/housekeeping/setup.F90</code>. All that the subroutine has to do is set
the variable <code>dt</code> to set the timestep for the whole code. Any
additional timestep constraints should be coded into this subroutine. This
should be implemented after the existing <code>dt=</code> lines but before the
line <code>dt = dt_multiplier * dt</code>. Such a modification should be set so
that it only changes the timestep if the timestep is MORE restrictive than that
calculated from the core code. An example would be:</p><pre><code class=language-perl> dt = dx * dy / SQRT(dx**2 + dy**2) / c
 dt = MIN(dt, my_new_dt)
</code></pre><p>In the core EPOCH code the timestep can be calculated identically on each
processor, so there is no requirement to synchronise the timestep across
multiple processors. If your new timestep restriction uses information local to
each processor then some additional lines must be added to the
<code>set_dt</code> routine after the timestep has been calculated which
should read:</p><pre><code class=language-perl> REAL(num) :: dt_global
         .
         .
         .
 CALL MPI_ALLREDUCE(dt_global, dt, 1, mpireal, MPI_MIN, comm, errcode)
 dt = dt_global
</code></pre><p>This uses another MPI command to determine the most restrictive timestep across
all processors. EPOCH is not written in a way that permits operation with
different timesteps on different processors, and the behaviour of the code is
undefined (and likely wrong) if the code runs with different timesteps on
different processors.</p><h2 id=input-deck-variables>Input deck variables</h2><ul><li><code>CHARACTER(LEN=entry_length) :: blank</code> - A special string which the input
deck parser uses to indicate that it&rsquo;s passing a blank string rather than a
string read from the deck which just happens to be blank.</li><li><code>INTEGER :: deck_state</code> - An integer determining the current sweep of
the input deck by the deck parser.</li><li><code>INTEGER, PARAMETER :: num_vars_to_dump</code> - A variable describing the
number of variables which should be selectable in the input deck as possible
variables to dump.</li><li><code>CHARACTER(LEN=entry_length) :: extended_error_string</code> - String used by
some error codes in the deck parser to give more user friendly error
messages.</li><li><code>INTEGER :: data_dir_max_length</code> - The maximum number of characters in
the name of the output directory.</li><li><code>INTEGER :: n_zeros</code> - The number of leading zeros in the output filenames
from EPOCH.</li></ul><h2 id=initial-conditions-autoloader-variables>Initial conditions (autoloader) variables</h2><p>Initial conditions for the autoloader for a given species are described in
EPOCH by the Fortran TYPE <code>initial_conditions_block</code>. The
definition (in 3D) is:</p><pre><code class=language-perl>TYPE initial_condition_block
 REAL(num), DIMENSION(:,:,:), POINTER :: density
 REAL(num), DIMENSION(:,:,:,:), POINTER :: temp
 REAL(num), DIMENSION(:,:,:,:), POINTER :: drift

 REAL(num) :: density_min
 REAL(num) :: density_max
END TYPE initial_condition_block
</code></pre><p>In 2D, the arrays have one fewer index, and in 1D they have two fewer.</p><ul><li><code>REAL(num) :: density</code> - Number density for the particles in the species.
When defined runs (-2:nx+3,-2:ny+3,-2:nz+3).</li><li><code>REAL(num) :: temp</code> - Temperature in Kelvin of the species in space. When
defined runs (-2:nx+3,-2:ny+3,-2:nz+3,1:3). The final index of the array
is a direction index, used to give anisotropic thermal distributions.</li><li><code>REAL(num) :: drift</code> - Velocity drift in $m/s$ of the species in space.
When defined runs (-2:nx+3,-2:ny+3,-2:nz+3,1:3). The final index of the array
is the velocity direction component.</li><li><code>density_min</code> - The minimum density below which the autoloader
should not load particles.</li><li><code>density_max</code> - The maximum density above which the autoloader
should clip the density function.</li></ul><p>The initial conditions themselves are in the variable</p><pre><code class=language-perl>TYPE(initial_condition_block), DIMENSION(:), ALLOCATABLE :: initial_conditions
</code></pre><p>which is allocated to an array of size <code>1:n_species</code>.</p></div><div class=article-widget><div class=post-nav><div class=post-nav-item><div class=meta-nav>Next</div><a href=/developer/core_structure/boundary_conditions.html rel=prev>Boundary Conditions</a></div></div></div></div><div class=body-footer><p>Last updated on Apr 4, 2023</p></div></article><footer class=site-footer><p class=powered-by>Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.</p></footer></main></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script><script>const code_highlighting=!0</script><script>const isSiteThemeDark=!1</script><script>const search_config={indexURI:"/index.json",minLength:1,threshold:.3},i18n={no_results:"No results found",placeholder:"Search...",results:"results found"},content_type={post:"Posts",project:"Projects",publication:"Publications",talk:"Talks"}</script><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.1/anchor.min.js integrity="sha256-pB/deHc9CGfFpJRjC43imB29Rse8tak+5eXqntO94ck=" crossorigin=anonymous></script><script>anchors.add()</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script src=/js/academic.min.6f1005d1a84220e2f466ff3d8e712f31.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div></body></html>