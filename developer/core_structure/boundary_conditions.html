<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.8.0"><meta name=description content="Boundary conditions in EPOCH are split into three types
 Simple field boundaries. Laser and outflow boundaries. Particle boundaries.  These boundaries can be combined in different ways to give different effects."><link rel=alternate hreflang=en-us href=/developer/core_structure/boundary_conditions.html><meta name=theme-color content="#3f51b5"><script src=/js/mathjax-config.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js integrity crossorigin=anonymous async></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"><link rel=stylesheet href=/css/academic.css><link rel=manifest href=/index.webmanifest><link rel=icon type=image/png href=/images/icon_hucf2a1ead28adac6bbe3177e5d4e4a1f0_753_32x32_fill_lanczos_center_2.png><link rel=apple-touch-icon type=image/png href=/images/icon_hucf2a1ead28adac6bbe3177e5d4e4a1f0_753_192x192_fill_lanczos_center_2.png><link rel=canonical href=/developer/core_structure/boundary_conditions.html><meta property="twitter:card" content="summary"><meta property="og:site_name" content="EPOCH"><meta property="og:url" content="/developer/core_structure/boundary_conditions.html"><meta property="og:title" content="Boundary Conditions | EPOCH"><meta property="og:description" content="Boundary conditions in EPOCH are split into three types
 Simple field boundaries. Laser and outflow boundaries. Particle boundaries.  These boundaries can be combined in different ways to give different effects."><meta property="og:image" content="/images/logo_hub4b4d6a0f57638acebb5550a80c8c030_9243_300x300_fit_lanczos_2.png"><meta property="twitter:image" content="/images/logo_hub4b4d6a0f57638acebb5550a80c8c030_9243_300x300_fit_lanczos_2.png"><meta property="og:locale" content="en-us"><meta property="article:modified_time" content="2023-04-04T13:41:14+01:00"><title>Boundary Conditions | EPOCH</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/><img src=/images/logo_hub4b4d6a0f57638acebb5550a80c8c030_9243_0x70_resize_lanczos_2.png alt=EPOCH></a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/><img src=/images/logo_hub4b4d6a0f57638acebb5550a80c8c030_9243_0x70_resize_lanczos_2.png alt=EPOCH></a></div><div class="navbar-collapse main-menu-item collapse justify-content-end" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/quickstart.html><span>Quick Start</span></a></li><li class=nav-item><a class=nav-link href=/documentation.html><span>User Guide</span></a></li><li class=nav-item><a class=nav-link href=/developer.html><span>Dev Guide</span></a></li><li class=nav-item><a class=nav-link href=/publication.html><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/license.html><span>License</span></a></li><li class=nav-item><a class=nav-link href=/contact.html><span>Contact</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=#><i class="fas fa-search" aria-hidden=true></i></a></li></ul></div></nav><div class="container-fluid docs"><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 docs-sidebar"><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-3" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation">
<span><i class="fas fa-bars"></i></span></button>
<input name=q type=search class=form-control placeholder=Search... autocomplete=off></form><nav class="collapse docs-links" id=docs-nav><div class=docs-toc-item><a class=docs-toc-link href=/developer.html>Overview</a><ul class="nav docs-sidenav"><li><a href=/developer/source_code_files.html>Source code files</a></li><li><a href=/developer/makefile.html>Makefile</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=/developer/core_structure.html>Core Structure</a><ul class="nav docs-sidenav"><li><a href=/developer/core_structure/basic_structures.html>Basic Structures</a></li><li><a href=/developer/core_structure/macro_particles.html>Particles</a></li><li><a href=/developer/core_structure/linked_lists.html>Linked Lists</a></li><li><a href=/developer/core_structure/partlist.html>Partlist</a></li><li><a href=/developer/core_structure/field_solver.html>Field Solver</a></li><li><a href=/developer/core_structure/particle_pusher.html>Particle Pusher</a></li><li><a href=/developer/core_structure/shape_functions.html>Weighting Functions</a></li><li><a href=/developer/core_structure/current_solver.html>Current solver</a></li><li class=active><a href=/developer/core_structure/boundary_conditions.html>Boundary Conditions</a></li><li><a href=/developer/core_structure/parallelism.html>Parallelism</a></li><li><a href=/developer/core_structure/precompiler_flags.html>Pre-compilation Flags</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=/developer/input_output.html>Input Output</a><ul class="nav docs-sidenav"><li><a href=/developer/input_output/basic_output.html>Basic Output</a></li><li><a href=/developer/input_output/string_handling.html>String Handling</a></li><li><a href=/developer/input_output/error_codes.html>Error Codes</a></li><li><a href=/developer/input_output/adding_outputs.html>Adding Outputs</a></li><li><a href=/developer/input_output/custom_maths_parser.html>Custom Maths Parser</a></li><li><a href=/developer/input_output/custom_deck.html>Custom Deck</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=/developer/extensions.html>Extending EPOCH</a><ul class="nav docs-sidenav"><li><a href=/developer/extensions/input_deck.html>Input Deck</a></li><li><a href=/developer/extensions/maths_parser.html>Maths Parser</a></li><li><a href=/developer/extensions/new_modules.html>New Module</a></li><li><a href=/developer/extensions/new_particle_variable.html>New Particle Variable</a></li></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>Contents</a></li></ul><nav id=TableOfContents><ul><li><a href=#simple-field-boundaries>Simple field boundaries</a></li><li><a href=#laser-and-outflow-boundaries>Laser and outflow boundaries</a></li><li><a href=#particle-boundaries>Particle boundaries</a></li><li><a href=#mpi-boundaries>MPI Boundaries</a></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role=main><article class=article><div class=docs-article-container><h1>Boundary Conditions</h1><div class=article-style><p>Boundary conditions in EPOCH are split into three types</p><ul><li>Simple field boundaries.</li><li>Laser and outflow boundaries.</li><li>Particle boundaries.</li></ul><p>These boundaries can be combined in different ways to give different
effects. From the end user perspective there are 4 boundaries which can be
applied to each edge of the simulation domain. These are</p><ul><li>Periodic<ul><li>Particles periodic</li><li>Fields periodic</li><li>Lasers off</li></ul></li><li>Other<ul><li>Particles reflect</li><li>Fields clamped zero</li><li>Lasers off</li></ul></li><li>Simple Laser<ul><li>Particles transmissive</li><li>Fields clamped zero</li><li>Lasers applied at half timestep for $B$ field</li></ul></li><li>Simple outflow<ul><li>Particles transmissive</li><li>Fields clamped zero</li><li>No lasers applied at half timestep, but outflow conditions applied
to $B$ field at half timestep</li></ul></li></ul><p>The boundary conditions are applied in too many places in the code to give a
full description of them, but the laser boundaries are only applied in
<code>src/fields.f90</code>. The boundaries requested by the user are converted
into the conditions on the fields and particles in the routine
<code>setup_particle_boundaries</code> in
<code>src/boundaries.F90</code>. For each of the six possible boundaries
(x_min, x_max, y_min, y_max, z_min, z_max) there is a variable which will
be named something like <code>bc_x_min_particle</code> or
<code>bc_y_max_field</code> which controls the boundary condition which will
be applied to either the field or the particles.</p><h2 id=simple-field-boundaries>Simple field boundaries</h2><p>There are two subroutines which apply the standard boundary conditions:
<code>field_zero_gradient</code> and <code>field_clamp_zero</code>. The
type of boundary condition that the two apply is obvious from the name, but
the two functions have different calling conventions.</p><pre><code class=language-perl>SUBROUTINE field_zero_gradient
  
REAL(num), DIMENSION(-2:,-2:,-2:), INTENT(INOUT) :: field
INTEGER, INTENT(IN) :: stagger_type, boundary
</code></pre><p><code>field_zero_gradient</code> is the routine which applies zero gradient
boundary conditions to a field variable passed in the parameter
<code>field</code>. The remaining two parameters are the stagger type and
the boundary number. These are named constants defined in
<code>src/shared_data.F90</code>, <code>c_stagger_*</code> for the
stagger type and <code>c_bd_*</code> for the boundary number.
The routine can be used as a global field boundary condition by
setting one of the field boundary conditions to c_bc_zero_gradient in
<code>setup_particle_boundaries</code>, but it is mostly used to give
boundary conditions for the autoloader.</p><pre><code class=language-perl>SUBROUTINE field_clamp_zero
  
REAL(num), DIMENSION(-2:,-2:,-2:), INTENT(INOUT) :: field
INTEGER, INTENT(IN) :: stagger_type, boundary
</code></pre><p><code>field_clamp_zero</code> is the routine which clamps the field given by
the <code>field</code> variable to zero on the boundary.
The remaining two parameters are the stagger type and
the boundary number. These are named constants defined in
<code>src/shared_data.F90</code>, <code>c_stagger_*</code> for the
stagger type and <code>c_bd_*</code> for the boundary number.</p><p>Additional boundary conditions should follow the same basic principle as these
routines. Note that all of the routines test for
<code>\{x,y,z\}_\{min,max\}_boundary</code> to confirm that a given processor is at the
edge of the real domain, and so should have a real boundary condition applied
to it. This also explains why there are no explicit periodic boundary condition
routines, since by connecting the processors cyclically in a periodic direction
the domain boundary effectively becomes another internal processor boundary.</p><h2 id=laser-and-outflow-boundaries>Laser and outflow boundaries</h2><p>The laser boundaries in EPOCH are based on a rewriting of Maxwell&rsquo;s
equations (combining Ampere-Maxwell and Faraday-Lenz) into a new form which
expresses the fields explicitly in terms of waves
propagating in both directions along each co-ordinate axis with both S and P
polarisation states. In the $x$ direction,</p><p>$$
\partial_t(E_y \pm cB_z) \pm \partial_x(E_y \pm cB_z) = \pm \partial_yE_x c + \partial_zB_x c^2 -\frac{j_y}{\epsilon_0}
$$</p><p>$$
\partial_t(E_z \mp cB_y) \pm \partial_x(E_z \mp cB_y) = \pm \partial_zE_x c - \partial_yB_x c^2 -\frac{j_z}{\epsilon_0}
$$</p><p>It is then possible to rewrite these equations to provide a boundary condition
on $B_z$ and $B_y$ to give propagating EM waves at the boundary. For waves
travelling into the boundary, this gives a transmissive boundary, and if the
components for waves propagating out from the boundary are set to be non-zero
then it also introduces an EM wave propagating from the left boundary.</p><p>This boundary condition is found in the file <code>laser.f90</code> which also
includes the routines for handling the <code>laser_block</code> objects which
represent how lasers are represented in EPOCH.</p><h2 id=particle-boundaries>Particle boundaries</h2><p>Due to the time that is required to loop over all the particles the particle
boundary conditions in EPOCH combine the inter-processor boundary conditions
with the real boundary conditions. The boundary conditions for particles are in
the routine <code>particle_bcs</code> in the file <code>boundary.f90</code><br>Currently EPOCH includes only three particle boundary conditions</p><ul><li>c_bc_open - Particles pass through the boundary and are destroyed. Total
pseudoparticle number is not conserved in this mode.</li><li>c_bc_periodic - Particles which leave one side of the box reappear on
the other side.</li><li>c_bc_reflect - Particles reflect off the boundary as if it was a hard
boundary.</li></ul><p>Although the routine looks rather messy, it is fairly easy to understand. The
sequence goes:</p><ul><li>Loop over all species.</li><li>Create particle list objects for particles to be sent to and received from
other processors.</li><li>Loop over all particles in the species.</li><li>If the particle has crossed a local boundary then it either
has crossed the boundary of the problem domain and needs a boundary condition
to be applied or it has just crossed a processor boundary and
needs to be transferred to a neighbouring process. Set
<code>{x,y,z}bd</code> which is used to identify which processor relative
to the current processor the particle potentially needs to be moved to and
then test for the domain boundary.</li><li>If the particle has crossed an open domain boundary then either add it to
another list to be dumped to disk if the user has requested this, or
otherwise just deallocate the particle to reclaim memory. Set
<code>out_of_bounds</code> to indicate that the particle has left the
system.</li><li>If the particle has crossed the domain boundary and that boundary has
reflecting boundary conditions then reflect the particle.</li><li>If the particle has crossed the domain boundary and that boundary has
periodic boundary conditions then move the particle to the opposite side
of the domain.</li><li>End particle loop.</li><li>Remove all the particles which have left the current process.</li><li>Loop over all possible neighbouring processors for the current processor
and exchange particle lists with that processor.</li><li>Add any received particles onto the particle list for the current
species.</li><li>End species loop.</li></ul><p>Note that, unlike for fields, there is explicit periodic boundary code. This is
because although the MPI routines place the particle on the correct processor
after the MPI routines, the particle&rsquo;s position variable still places it beyond
the other end of the domain. The MPI parallelism for exchanging particles is
hidden in the routines which deal with the particle list objects and are
described in the next section.</p><h2 id=mpi-boundaries>MPI Boundaries</h2><p>There are three routines which deal with MPI exchange for field variables in
EPOCH. Two are closely related and will be considered together. The third
deals with using MPI to sum variables at processor boundaries rather than
synchronise ghost cells.</p><pre><code class=language-perl>SUBROUTINE field_bc
  
REAL(num), DIMENSION(-2:,-2:,-2:), INTENT(INOUT) :: field
</code></pre><p><code>field_bc</code> exchanges the information in the ghost cells between
adjacent processors. Any field variable which is used in a calculation that
requires operations involving information from points other than the
current point should call this routine each time the variable is updated. This
will ensure that the ghost cells are populated from adjacent processors.
(i.e. if you only need to access field(ix,iy,iz) there is no need to update
ghost cells, whilst if you use field(ix-1,iy,iz) you do).</p><p>The <code>field_bc</code> routine just calls the
<code>do_field_mpi_with_lengths</code> routine which is a more general
routine that allows ghost cell information to be exchanged for fields with
an arbitrary number of cells, rather than fields which are
(-2:nx+3,-2:ny+3,-2:nz+3). This routine is used internally in the load
balancing routine when fields with both the old and new sizes must be handled
at the same time.</p><pre><code class=language-perl>SUBROUTINE processor_summation_bcs
  
REAL(num), DIMENSION(-2:,-2:,-2:), INTENT(INOUT) :: field
INTEGER, INTENT(IN), OPTIONAL :: flip_direction
</code></pre><p><code>processor_summation_bcs</code> is a routine which is used to deal with
variables, like $\vec{j}$ or number density that should be added at boundaries
to include contributions from particles on both sides of a processor boundary.
The routine is used for the current inside the particle pusher and inside most
of the routines for calculating derived variables. If you have a variable
which needs to add contributions from adjacent processors then you should
calculate the quantity on each processor, including contributions from the
particles to the ghost cells and then call this routine. When reflecting
boundary conditions are in operation, the current in the direction crossing
the boundary needs to be flipped over. This is decided upon using the
<code>flip_direction</code> parameter.</p><p>These routines can be used for most MPI calls required by all but the most
extreme modifications to EPOCH.</p></div><div class=article-widget><div class=post-nav><div class=post-nav-item><div class=meta-nav>Previous</div><a href=/developer/core_structure/basic_structures.html rel=next>Basic Structures</a></div><div class=post-nav-item><div class=meta-nav>Next</div><a href=/developer/core_structure/current_solver.html rel=prev>Current solver</a></div></div></div></div><div class=body-footer><p>Last updated on Apr 4, 2023</p></div></article><footer class=site-footer><p class=powered-by>Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.</p></footer></main></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script><script>const code_highlighting=!0</script><script>const isSiteThemeDark=!1</script><script>const search_config={indexURI:"/index.json",minLength:1,threshold:.3},i18n={no_results:"No results found",placeholder:"Search...",results:"results found"},content_type={post:"Posts",project:"Projects",publication:"Publications",talk:"Talks"}</script><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.1/anchor.min.js integrity="sha256-pB/deHc9CGfFpJRjC43imB29Rse8tak+5eXqntO94ck=" crossorigin=anonymous></script><script>anchors.add()</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script src=/js/academic.min.6f1005d1a84220e2f466ff3d8e712f31.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div></body></html>