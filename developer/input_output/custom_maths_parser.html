<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.8.0"><meta name=description content="Sometimes the complexity in changing the input.deck file is due to the fact that a function which must be used is fairly complex in form and is not supplied with the core code."><link rel=alternate hreflang=en-us href=/developer/input_output/custom_maths_parser.html><meta name=theme-color content="#3f51b5"><script src=/js/mathjax-config.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js integrity crossorigin=anonymous async></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"><link rel=stylesheet href=/css/academic.css><link rel=manifest href=/index.webmanifest><link rel=icon type=image/png href=/images/icon_hucf2a1ead28adac6bbe3177e5d4e4a1f0_753_32x32_fill_lanczos_center_2.png><link rel=apple-touch-icon type=image/png href=/images/icon_hucf2a1ead28adac6bbe3177e5d4e4a1f0_753_192x192_fill_lanczos_center_2.png><link rel=canonical href=/developer/input_output/custom_maths_parser.html><meta property="twitter:card" content="summary"><meta property="og:site_name" content="EPOCH"><meta property="og:url" content="/developer/input_output/custom_maths_parser.html"><meta property="og:title" content="Custom Maths Parser | EPOCH"><meta property="og:description" content="Sometimes the complexity in changing the input.deck file is due to the fact that a function which must be used is fairly complex in form and is not supplied with the core code."><meta property="og:image" content="/images/logo_hub4b4d6a0f57638acebb5550a80c8c030_9243_300x300_fit_lanczos_2.png"><meta property="twitter:image" content="/images/logo_hub4b4d6a0f57638acebb5550a80c8c030_9243_300x300_fit_lanczos_2.png"><meta property="og:locale" content="en-us"><meta property="article:modified_time" content="2023-04-04T13:41:14+01:00"><title>Custom Maths Parser | EPOCH</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/><img src=/images/logo_hub4b4d6a0f57638acebb5550a80c8c030_9243_0x70_resize_lanczos_2.png alt=EPOCH></a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/><img src=/images/logo_hub4b4d6a0f57638acebb5550a80c8c030_9243_0x70_resize_lanczos_2.png alt=EPOCH></a></div><div class="navbar-collapse main-menu-item collapse justify-content-end" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/quickstart.html><span>Quick Start</span></a></li><li class=nav-item><a class=nav-link href=/documentation.html><span>User Guide</span></a></li><li class=nav-item><a class=nav-link href=/developer.html><span>Dev Guide</span></a></li><li class=nav-item><a class=nav-link href=/publication.html><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/license.html><span>License</span></a></li><li class=nav-item><a class=nav-link href=/contact.html><span>Contact</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=#><i class="fas fa-search" aria-hidden=true></i></a></li></ul></div></nav><div class="container-fluid docs"><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 docs-sidebar"><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-3" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation">
<span><i class="fas fa-bars"></i></span></button>
<input name=q type=search class=form-control placeholder=Search... autocomplete=off></form><nav class="collapse docs-links" id=docs-nav><div class=docs-toc-item><a class=docs-toc-link href=/developer.html>Overview</a><ul class="nav docs-sidenav"><li><a href=/developer/source_code_files.html>Source code files</a></li><li><a href=/developer/makefile.html>Makefile</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=/developer/core_structure.html>Core Structure</a><ul class="nav docs-sidenav"><li><a href=/developer/core_structure/basic_structures.html>Basic Structures</a></li><li><a href=/developer/core_structure/macro_particles.html>Particles</a></li><li><a href=/developer/core_structure/linked_lists.html>Linked Lists</a></li><li><a href=/developer/core_structure/partlist.html>Partlist</a></li><li><a href=/developer/core_structure/field_solver.html>Field Solver</a></li><li><a href=/developer/core_structure/particle_pusher.html>Particle Pusher</a></li><li><a href=/developer/core_structure/shape_functions.html>Weighting Functions</a></li><li><a href=/developer/core_structure/current_solver.html>Current solver</a></li><li><a href=/developer/core_structure/boundary_conditions.html>Boundary Conditions</a></li><li><a href=/developer/core_structure/parallelism.html>Parallelism</a></li><li><a href=/developer/core_structure/precompiler_flags.html>Pre-compilation Flags</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=/developer/input_output.html>Input Output</a><ul class="nav docs-sidenav"><li><a href=/developer/input_output/basic_output.html>Basic Output</a></li><li><a href=/developer/input_output/string_handling.html>String Handling</a></li><li><a href=/developer/input_output/error_codes.html>Error Codes</a></li><li><a href=/developer/input_output/adding_outputs.html>Adding Outputs</a></li><li class=active><a href=/developer/input_output/custom_maths_parser.html>Custom Maths Parser</a></li><li><a href=/developer/input_output/custom_deck.html>Custom Deck</a></li></ul></div><div class=docs-toc-item><a class=docs-toc-link href=/developer/extensions.html>Extending EPOCH</a><ul class="nav docs-sidenav"><li><a href=/developer/extensions/input_deck.html>Input Deck</a></li><li><a href=/developer/extensions/maths_parser.html>Maths Parser</a></li><li><a href=/developer/extensions/new_modules.html>New Module</a></li><li><a href=/developer/extensions/new_particle_variable.html>New Particle Variable</a></li></ul></div></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>Contents</a></li></ul><nav id=TableOfContents><ul><li><a href=#registering-your-new-constantfunction>Registering your new constant/function</a></li><li><a href=#setting-up-new-constants>Setting up new constants</a></li><li><a href=#setting-up-new-functions>Setting up new functions</a></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role=main><article class=article><div class=docs-article-container><h1>Custom Maths Parser</h1><div class=article-style><p>Sometimes the complexity in changing the input.deck file is due to the fact that
a function which must be used is fairly complex in form and is not supplied
with the core code. It must therefore be represented in the input deck maths
parser. This can be a significant cause of complexity for some problems, and
in this case, there are three options:</p><ol><li>Put up with it and implement in the deck</li><li>Use the internal initial conditions rather than the deck</li><li>Extend the maths parser to include your function</li></ol><p>Extending the maths parser can either
be permanent (described in extensions) or temporary (described
here). All of the routines used in extending the maths parser are in the file
<code>user_interaction/custom_parser.f90</code>. Temporarily adding elements to the parser
is much easier than a permanent addition. It is
possible to add new constants and functions to the maths parser. It is hoped
that in a future release of EPOCH this will be extended to allow custom
operators as well.</p><p>As an example, lets look at adding a new function (lorentz) for a
Lorentzian distribution, and adding a new constant, phi.</p><h2 id=registering-your-new-constantfunction>Registering your new constant/function</h2><p>Before a new constant or function
can be defined it must be registered. In the registration phase the text
representation of the function or constant is given to the parser subroutines
and the user is returned an integer handle for the registered object. The
numerical handle must be stored so that that all of the functions in this
module can access it, so they should be placed after the <code>IMPLICIT NONE</code> statement at the top of the file and defined as:</p><pre><code class=language-perl>INTEGER :: c_func_lorentz
INTEGER :: c_const_phi
</code></pre><p>Note that the names given to the constants is obviously at the developers
discretion, but these names comply with the EPOCH style guide.
Actually registering the objects is done in the <code>register_objects</code>
subroutine which should include lines to register functions and constants.
An example is given below.</p><pre><code class=language-perl>SUBROUTINE register_objects

 c_func_lorentz = register_function(&quot;lorentz&quot;)
 c_const_phi = register_constant(&quot;phi&quot;)

END SUBROUTINE register_objects
</code></pre><p>Note that the input deck parser is case sensitive, so the strings which are
given to <code>register_function</code> and <code>register_constant</code>
should be in the case that they will appear in the input deck. To follow the
EPOCH style guide this should be all lowercase. At this point, the maths
parser would start to recognise the new function/constant, but would still
give error messages since they haven&rsquo;t yet been implemented.</p><h2 id=setting-up-new-constants>Setting up new constants</h2><p>Once a new constant has been registered it must be described using the
<code>custom_constant</code> function. In 2D this function looks like:</p><pre><code class=language-perl>FUNCTION custom_constant(opcode, ix, iy, errcode)

 INTEGER, INTENT(IN) :: opcode, ix, iy
 INTEGER, INTENT(INOUT) :: errcode
 REAL(num) :: custom_constant

 ! Leave these lines in place. They cause the code to throw an error if
 ! The opcode is unknown
 custom_constant = 0.0_num
 errcode = IOR(errcode, c_err_unknown_element)

END FUNCTION custom_constant
</code></pre><p>The parameters are</p><ul><li><code>opcode</code> - The operator code of the constant requested. This will be the
integer handle returned from <code>register_constant</code>.</li><li><code>ix</code>, <code>iy</code>, <code>iz</code> - Some constants are actually evaluated at specific points in
space and ix, iy, iz are the gridpoint number of the location currently being
evaluated. If you are specifying a simple constant then just ignore
these. If your constant does depend upon space then directly subscript your
array with ix, iy, iz as needed to read the correct location.</li><li><code>errcode</code> - The error code which should be passed back to the
parser. If for some reason you cannot evaluate your constant then you should
<code>IOR</code> errcode with the appropriate error code (all the error
codes are listed in appendix A). Note that errcode should never be SET to
any specific error code when extending the parser, since this might
overwrite errors put in place earlier in the parsing sequence. This is
different to extending the input deck where the error code is set.</li></ul><p>The function should just return the evaluated value of the constant requested
by <code>opcode</code>. This might look like:</p><pre><code class=language-perl>FUNCTION custom_constant(opcode, ix, iy, errcode)

 INTEGER, INTENT(IN) :: opcode, ix, iy
 INTEGER, INTENT(INOUT) :: errcode
 REAL(num) :: custom_constant

 IF (opcode .EQ. c_const_phi) THEN
   custom_constant = pi
   RETURN
 ENDIF

 ! Leave these lines in place. They cause the code to throw an error if
 ! The opcode is unknown
 custom_constant = 0.0_num
 errcode = IOR(errcode, c_err_unknown_element)

END FUNCTION custom_constant
</code></pre><p>Note that when <code>opcode</code> is successfully recognised, the code sets
the return value and returns straight away. This is how all constants should
work, since the last line forces the function to return an error code. This
last line is in place to trap people registering constants but never defining
them. Without this line, it is possible to define a constant which is
never specified and have the code complete OK with a random value for that
constant.</p><p>The constant &ldquo;phi&rdquo; should now work fine when used anywhere in the input deck
and will return a value of $\pi$.</p><h2 id=setting-up-new-functions>Setting up new functions</h2><p>Setting up the new function <code>lorentz</code> is very similar to setting up
the new constant. The relevant function is <code>custom_function</code> and
when empty looks like:</p><pre><code class=language-perl>FUNCTION custom_function(opcode, ix, iy, errcode)

 INTEGER, INTENT(IN) :: opcode, ix, iy
 INTEGER, INTENT(INOUT) :: errcode
 REAL(num) :: custom_function
 REAL(num) :: values(5)

 ! Leave these lines in place. They cause the code to throw an error if
 ! The opcode is unknown
 custom_function = 0.0_num
 errcode = IOR(errcode, c_err_unknown_element)

END FUNCTION custom_function
</code></pre><p>The parameters are</p><ul><li><code>opcode</code> - The operator code of the constant requested. This will be the
integer handle returned from \inlinecode {register_function}.</li><li><code>ix</code>, <code>iy</code>, <code>iz</code> - Some functions are evaluated differently at specific points
in space and ix, iy, iz are the gridpoint number of the location currently
being evaluated. If you are specifying a simple function then just
ignore these. If your function does depend upon space then directly
subscript your array with ix, iy, iz as needed to read the correct location.</li><li><code>errcode</code> - The error code which should be passed back to the
parser. If for some reason you cannot evaluate your function then you should
<code>IOR</code> errcode with the appropriate error code. Note that errcode
should never be SET to any specific error code, since this might overwrite
errors put in place earlier in the parsing sequence.</li></ul><p>The function should return the value of your evaluated constant. The
parameters which are passed to the function can be retrieved by the function
<code>get_values(n, values)</code>, where <code>n</code> is the number of
parameters to be returned and <code>values</code> is a <code>REAL(num)</code>
array of length <code>n</code> which will hold the returned values . In this
implementation of the Lorentzian function there are three parameters: The
dependent variable, the location parameter and the scale parameter. The code
to implement the function therefore looks like:</p><pre><code class=language-perl>FUNCTION custom_function(opcode, ix, iy, errcode)

 INTEGER, INTENT(IN) :: opcode, ix, iy
 INTEGER, INTENT(INOUT) :: errcode
 REAL(num) :: custom_function
 REAL(num) :: values(5)

 IF (opcode .EQ. c_func_lorentz) THEN
   CALL get_values(3, values(1:3))
   ! values(1) - Dependent variable
   ! values(2) - location parameter
   ! values(3) - scale parameter
   custom_function = values(3)**2/((values(1)-values(2))**2+values(3)**2)
   RETURN
 ENDIF

 ! Leave these lines in place. They cause the code to throw an error if
 ! The opcode is unknown
 custom_function = 0.0_num
 errcode = IOR(errcode, c_err_unknown_element)

END FUNCTION custom_function
</code></pre><p>This function is then available at any point in the input deck and if I return
to the previous example ic.deck file, it would be used as follows:</p><pre><code class=language-perl>begin:constant
  particle_density = 100.0 # Particle number density
  profile_x = lorentz(x,0.0,1.0)
  profile_y = lorentz(y,0.0,1.0)
end:constant

begin:species
  name = s1

  # multiply density by real particle density
  density = particle_density * profile_x * profile_y

  # Set the temperature to be zero
  temp_x = 0.0
  temp_y = temp_x(s1)

  # Set the minimum density for this species
  density_min = 0.3*particle_density
end:species

begin:species
  name = s2

  # Just copy the density for species s1
  density = density(s1)

  # Just copy the temperature from species s1
  temp_x = temp_x(s1)
  temp_y = temp_y(s1)

  # Set the minimum density for this species
  density_min = 0.3*particle_density
end:species
</code></pre><p>It is therefore clear that the new lorentz function is essentially the same as
the built in gauss function. Note that due to the way that the parser works,
the end user is not required to deal with parameters which are themselves
maths expressions. They have been fully evaluated by the time they are
returned by <code>get_values</code>. Note that the parser is not guaranteed to
be bulletproof. If a user calls <code>get_values</code> requesting more
parameters than have been passed to the function then it will scramble the
stack which is used by the parser and cause the code to fail. Note that
calling <code>get_values(2, values)</code> is not the same as calling
<code>get_values(1, values)</code> twice, in fact calling
<code>get_values(1, values)</code> multiple times will return the parameters in
<em>reverse</em> order. This is normal and is a feature of how the maths parser
operates. It is possible to use this property to write functions which have a
variable number of parameters, but this is not recommended.</p></div><div class=article-widget><div class=post-nav><div class=post-nav-item><div class=meta-nav>Previous</div><a href=/developer/input_output/custom_deck.html rel=next>Custom Deck</a></div><div class=post-nav-item><div class=meta-nav>Next</div><a href=/developer/input_output/error_codes.html rel=prev>Error Codes</a></div></div></div></div><div class=body-footer><p>Last updated on Apr 4, 2023</p></div></article><footer class=site-footer><p class=powered-by>Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.</p></footer></main></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script><script>const code_highlighting=!0</script><script>const isSiteThemeDark=!1</script><script>const search_config={indexURI:"/index.json",minLength:1,threshold:.3},i18n={no_results:"No results found",placeholder:"Search...",results:"results found"},content_type={post:"Posts",project:"Projects",publication:"Publications",talk:"Talks"}</script><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.1/anchor.min.js integrity="sha256-pB/deHc9CGfFpJRjC43imB29Rse8tak+5eXqntO94ck=" crossorigin=anonymous></script><script>anchors.add()</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script src=/js/academic.min.6f1005d1a84220e2f466ff3d8e712f31.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div></body></html>